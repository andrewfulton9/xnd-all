

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Generating new kernels for gumath &mdash; Plures v0.2.0dev3 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://xnd.io/xndtools/tutorials/getting_started.html"/>
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Running kernels on the GPU" href="gpu_kernel.html" />
    <link rel="prev" title="Representation of XND objects" href="../notes/notes1.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/xndlogo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v0.2.0dev3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../libxnd/index.html">libxnd</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../xnd/index.html">xnd</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../libgumath/index.html">libgumath</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gumath/index.html">gumath</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">xndtools</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#kernel-generator">kernel_generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#notes">Notes</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#tutorials">Tutorials</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Generating new kernels for gumath</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#kernel-generator">Kernel generator</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="gpu_kernel.html">Running kernels on the GPU</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Releases</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Plures</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">xndtools</a> &raquo;</li>
        
      <li>Generating new kernels for gumath</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="generating-new-kernels-for-gumath">
<h1>Generating new kernels for gumath<a class="headerlink" href="#generating-new-kernels-for-gumath" title="Permalink to this headline">¶</a></h1>
<p>Operations on XND containers live in the <a class="reference external" href="https://github.com/plures/gumath">gumath</a> library. It already provides binary
operations like add, subtract, multiply and divide, and unary operations like
abs, exponential, logarithm, power, trigonometric functions, etc. They can
operate on various data types, e.g. <code class="docutils literal notranslate"><span class="pre">int32</span></code> or <code class="docutils literal notranslate"><span class="pre">float64</span></code>. But you might want
to create your own kernel, either from a code that you wrote or from an existing
library. This tutorial will show how to do that using the kernel generator from
XND Tools.</p>
<div class="section" id="kernel-generator">
<h2>Kernel generator<a class="headerlink" href="#kernel-generator" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/plures/xndtools">XND Tools</a> provide development tools for
XND. Among them, <code class="docutils literal notranslate"><span class="pre">xndtools.kernel_generator</span></code> facilitates the creation of new
kernels by semi-automatically wrapping e.g. C code. Fortran will be supported in
the future, as there are tons of high performance libraries out there.</p>
<div class="section" id="wrapping-c-code">
<h3>Wrapping C code<a class="headerlink" href="#wrapping-c-code" title="Permalink to this headline">¶</a></h3>
<p>Let’s say we want to make a kernel out of the following C function, which just
squares a number:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// file: square.c</span>

<span class="cp">#include</span> <span class="cpf">&quot;square.h&quot;</span><span class="cp"></span>

<span class="kt">double</span> <span class="nf">square</span><span class="p">(</span><span class="kt">double</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is the implementation of the function that we want to turn into a kernel,
but the kernel generator is only concerned about its prototype, which looks like
this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// file: square.h</span>

<span class="k">extern</span> <span class="kt">double</span> <span class="nf">square</span><span class="p">(</span><span class="kt">double</span><span class="p">);</span>
</pre></div>
</div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">extern</span></code> keyword: because this header file will be used by the kernel
generator to build the kernel, the <code class="docutils literal notranslate"><span class="pre">square</span></code> function will be assumed to be
available somewhere else. We will then be able to compile the kernel and the
<code class="docutils literal notranslate"><span class="pre">square.c</span></code> file independently, and link them later. This is not so important
in our simple example, but it could be if we were wrapping an existing library
like LAPACK, which has its own build process. The kernel generator doesn’t need
to know how to build the library, all it needs is a header file with the
function prototypes.</p>
<p>Now run the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ xnd_tools config square.h
</pre></div>
</div>
<p>This creates an initial kernel configuration file <code class="docutils literal notranslate"><span class="pre">square-kernels.cfg</span></code>, which
looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[MODULE square]
typemaps =
      double: float64
includes =
      square.h
include_dirs =

libraries =

library_dirs =

header_code =
kinds = Xnd
ellipses = ..., var...

[KERNEL square]
skip = # REMOVE THIS LINE WHEN READY
prototypes =
      double square(double   a);
description =
dimension =
input_arguments = a
inplace_arguments =
inout_arguments =
output_arguments =
hide_arguments =
</pre></div>
</div>
<p>For this simple kernel, we don’t actually have to change anything, so we’ll just
remove the <code class="docutils literal notranslate"><span class="pre">skip</span></code> line as indicated, and save the file.</p>
<p>The next step is about creating the interface to <code class="docutils literal notranslate"><span class="pre">gumath</span></code>, and registering our
<code class="docutils literal notranslate"><span class="pre">square</span></code> function as a kernel. The following command will create a
<code class="docutils literal notranslate"><span class="pre">square-kernels.c</span></code> file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ xnd_tools kernel square-kernels.cfg
</pre></div>
</div>
<p>For now we are still in the C world, so we also need to expose our kernel to
Python. This is done by creating an extension module. Fortunately, XND tools
does that for us as well. The following command will create the
<code class="docutils literal notranslate"><span class="pre">square-python.c</span></code> file. Note that it also creates the <code class="docutils literal notranslate"><span class="pre">square-kernels.c</span></code>
file if it does not already exists, so the previous command is not necessary
here.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ xnd_tools module square-kernels.cfg
</pre></div>
</div>
<p>Assuming the variable <code class="docutils literal notranslate"><span class="pre">$SITE_PACKAGES</span></code> contains the path to your Python
<code class="docutils literal notranslate"><span class="pre">site-packages</span></code> directory, where <code class="docutils literal notranslate"><span class="pre">xnd</span></code>, <code class="docutils literal notranslate"><span class="pre">ndtypes</span></code>, <code class="docutils literal notranslate"><span class="pre">gumath</span></code> and
<code class="docutils literal notranslate"><span class="pre">xndtools</span></code> are installed (given by <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-c</span> <span class="pre">&quot;from</span> <span class="pre">distutils.sysconfig</span>
<span class="pre">import</span> <span class="pre">get_python_lib;</span> <span class="pre">print(get_python_lib())&quot;</span></code>), you can compile the square
function, its kernel, and create a static library with the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ gcc -fPIC                                   <span class="se">\</span>
  -c square.c                                 <span class="se">\</span>
  -c square-kernels.c -fPIC                   <span class="se">\</span>
  -I<span class="nv">$SITE_PACKAGES</span>/ndtypes                    <span class="se">\</span>
  -I<span class="nv">$SITE_PACKAGES</span>/xnd                        <span class="se">\</span>
  -I<span class="nv">$SITE_PACKAGES</span>/gumath                     <span class="se">\</span>
  -I<span class="nv">$SITE_PACKAGES</span>/xndtools/kernel_generator
$ ar rcs libsquare-kernels.a square-kernels.o square.o
</pre></div>
</div>
<p>Then building a C extension for CPython can be done using <code class="docutils literal notranslate"><span class="pre">distutils</span></code>. It just
needs a <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> script, which for our simple case looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># file: setup.py</span>

<span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="nn">distutils.sysconfig</span> <span class="kn">import</span> <span class="n">get_python_lib</span>

<span class="n">site_packages</span> <span class="o">=</span> <span class="n">get_python_lib</span><span class="p">()</span>
<span class="n">libs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ndtypes&#39;</span><span class="p">,</span><span class="s1">&#39;gumath&#39;</span><span class="p">,</span> <span class="s1">&#39;xnd&#39;</span><span class="p">]</span>
<span class="n">lib_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;{site_packages}/{lib}&#39;</span> <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">libs</span><span class="p">]</span>

<span class="n">module1</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">(</span><span class="s1">&#39;square&#39;</span><span class="p">,</span>
                    <span class="n">include_dirs</span> <span class="o">=</span> <span class="n">lib_dirs</span><span class="p">,</span>
                    <span class="n">libraries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;square-kernels&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">libs</span><span class="p">,</span>
                    <span class="n">library_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lib_dirs</span><span class="p">,</span>
                    <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;square-python.c&#39;</span><span class="p">])</span>

<span class="n">setup</span> <span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;square&#39;</span><span class="p">,</span>
       <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
       <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;This is a gumath kernel extension that squares an XND container&#39;</span><span class="p">,</span>
       <span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">module1</span><span class="p">])</span>
</pre></div>
</div>
<p>Finally, we can build and install our extension with the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python setup.py install
</pre></div>
</div>
<p>If everything went fine, we can now test it in the Python console:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">xnd</span> <span class="k">import</span> <span class="n">xnd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">square</span> <span class="k">import</span> <span class="n">square</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">xnd</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span>
<span class="go">xnd([1.0, 2.0, 3.0], type=&#39;3 * float64&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">square</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="go">xnd([1.0, 4.0, 9.0], type=&#39;3 * float64&#39;)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="gpu_kernel.html" class="btn btn-neutral float-right" title="Running kernels on the GPU" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../notes/notes1.html" class="btn btn-neutral float-left" title="Representation of XND objects" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, Plures Project
      <span class="lastupdated">
        Last updated on True.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>